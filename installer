#!/usr/bin/env bash

command -v git &>/dev/null || (echo 'Install git' ; exit 1)
code_dir="${BASH_SOURCE%/*}"
. "${code_dir}/source_me.bash" || (echo 'Missing source_me.bash' ; exit 1)
rm -rf "${GBRS_DIR}"

echo 'You already have a repository in cloud, right?
If not, create one at any of the following for free:
github.com, gitlab.com, sourceforge.net, bitbucket.org
'
read -ep 'URL: ' url
[[ -z "${url}" ]] && exit
uri="${url#*:\/\/}"
protocol="${url%:\/\/*}"

if [[ "${protocol}" == "file" ]] || [[ -n "${protocol}" ]]; then
  fetch_url="${uri}"
  push_url="${uri}"
  localhost="true"
else
  fetch_url="git://${uri}"
  localhost="false"
fi

if [[ "${protocol}" == "ssh" ]]; then
  echo 'No support for ssh yet. Lets use https.'
  protocol="https"
fi

if [[ "${protocol}" == "https" ]]; then
  read -ep 'Username: ' uid
  read -ep 'Passwd/PAT: ' pass
  tput cuu1; tput el1; echo 'Got your passwd.'
  push_url="https://${uid}:${pass}@${uri}"
fi

echo 'You shall be using this PC as'
read -p '1. Server 2. Client: ' -n1 choice
while true;do
  case "${choice}" in
    1)config="server"; talkto="client"; break;;
    2)config="client"; talkto="server"; break;;
    *)read -p 'Type either 1 or 2: ' -n1 choice;;
  esac
done
echo

if ! "${localhost}"; then
  echo 'Make sure you are connected to internet. Press any key after that.'
  read -sn1
fi

echo "Configuring ${config}..."
GBRS_filesys
mkdir -p "${GBRS_DIR}"
touch "${incoming}"

git clone --bare "${fetch_url}" "${git_dir}" || (echo exiting; exit 1)
cd "${git_dir}"
git remote set-url --push origin "${push_url}"

# Check if repo has atleast one commit; create a commit if there is none
git show -s &>/dev/null || (git clone -q . ../main; cd ../main; \
git commit --allow-empty -m 'Root commit'; git push -q origin)

# Create outgoing directory; checked out with appropriate branch
git worktree add "${outgoing_dir}" "${talkto}" &>/dev/null \
|| \
(git worktree add -b "${talkto}" "${outgoing_dir}" &>/dev/null
git push origin "${talkto}"
)

# Create incoming directory; checked out with appropriate branch
git worktree add "${incoming_dir}" "${config}" &>/dev/null \
|| \
(git worktree add -b "${config}" "${incoming_dir}" &>/dev/null
git push origin "${config}"
)

ln "${code_dir}/post-commit" "${git_dir}/hooks/post-commit" || \
  (echo 'Missing post-commit hook' ; exit 1)
